==============================
****truongcx/plutus images****
==============================
FROM ubuntu:20.04 AS build

LABEL maintainer="VNPIPS Staking Team (ada.vnpips.com)"

#ARG DEBIAN_FRONTEND=noninteractive
ENV \
    ENV=/etc/profile \
    LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US.UTF-8  \
    TZ=Asia/Ho_Chi_Minh

#  en_US.UTF-8 for inclusion in generation

RUN sed -i 's/^# *\(en_US.UTF-8\)/\1/' /etc/locale.gen \
    && locale-gen \
    && echo "export LC_ALL=en_US.UTF-8" >> ~/.bashrc \
    && echo "export LANG=en_US.UTF-8" >> ~/.bashrc \
    && echo "export LANGUAGE=en_US.UTF-8" >> ~/.bashrc

RUN sudo add-apt-repository universe \
  && sudo add-apt-repository multiverse \
  && sudo apt update \
  && sudo apt upgrade 

# Configure tzdata
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Switch to root user : to run privileged command
# --- Usually you won't be needed it - Depends on base image
USER root
WORKDIR /

# Update and install the required packages
RUN apt-get update \
  && apt-get install -y \
     automake autoconf build-essential pkg-config \
     libffi-dev libgmp-dev libssl-dev libtinfo-dev \
     libsystemd-dev libncursesw5 libtool zlib1g-dev \
     make g++ tmux git jq wget curl zip unzip rsync  \
     cron nano sudo \
  && apt-get autoremove \
  && apt-get autoclean

# SETUP NONEROOTUSER
ARG NONEROOTUSER=vnpip

RUN adduser --disabled-password --gecos '' $NONEROOTUSER \
    && echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers \
    && adduser $NONEROOTUSER sudo \
    && chown -R $NONEROOTUSER:$NONEROOTUSER /home/$NONEROOTUSER/.*

# Run non-privileged command
USER $NONEROOTUSER
#WORKDIR /home/$NONEROOTUSER

# Build and install the IOHK fork of [libsodium].
RUN git clone https://github.com/input-output-hk/libsodium \
    && cd libsodium \
    && git checkout 66f017f1 \
    && ./autogen.sh \
    && ./configure \
    && make \
    && make install \
    && cd .. && rm -rf libsodium

# Install [GHC]
ADD addfile/ghc-version.txt ./
RUN GHCVERSION=$(cat ghc-version.txt) \
  && wget https://downloads.haskell.org/ghc/$GHCVERSION/ghc-$GHCVERSION-x86_64-deb9-linux.tar.xz \
  && tar -xf ghc-$GHCVERSION-x86_64-deb9-linux.tar.xz \
  && rm ghc-$GHCVERSION-x86_64-deb9-linux.tar.xz \
  && cd ghc-$GHCVERSION \
  && ./configure \
  && make install \
  && ghc --version \
  && cd .. \
  && rm -rf /ghc-$GHCVERSION

# Install [cabal]
ADD addfile/cabal-version.txt ./ 
RUN CBVERSION=$(cat cabal-version.txt) \
  && wget https://downloads.haskell.org/~cabal/cabal-install-$CBVERSION/cabal-install-$CBVERSION-x86_64-unknown-linux.tar.xz \
  && tar -xf cabal-install-$CBVERSION-x86_64-unknown-linux.tar.xz \
  && rm cabal-install-$CBVERSION-x86_64-unknown-linux.tar.xz cabal.sig \
  && mv cabal ~/.cabal/bin/ \
# && mv cabal /usr/local/bin/ \
  && ~/.cabal/bin/cabal update \
  && ~/.cabal/bin/cabal --version \
  && cd ..
  
# STEP ONE: INSTALL NIX
# RUN curl -L https://nixos.org/nix/install | sh

# INSTALL NIX
RUN sudo curl -sL https://nixos.org/nix/install | sh \
    && sudo ln -s /nix/var/nix/profiles/per-user/etc/profile.d/nix.sh /etc/profile.d/ \
    && . /home/$NONEROOTUSER/.nix-profile/etc/profile.d/nix.sh \
    && echo "export PATH=/nix/var/nix/profiles/per-user/$NONEROOTUSER/profile/bin:/nix/var/nix/profiles/per-user/$NONEROOTUSER/profile/sbin:/opt/cardano/cnode/scripts:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/home/$NONEROOTUSER/.cabal/bin"  >> ~/.bashrc

# INSTALL DEPS  
RUN /nix/var/nix/profiles/per-user/$NONEROOTUSER/profile/bin/nix-env -i python3 systemd libsodium tmux jq ncurses libtool autoconf git wget gnupg column less openssl vim \
    && /nix/var/nix/profiles/per-user/$NONEROOTUSER/profile/bin/nix-channel --update \
    && /nix/var/nix/profiles/per-user/$NONEROOTUSER/profile/bin/nix-env -u --always \
    && /nix/var/nix/profiles/per-user/$NONEROOTUSER/profile/bin/nix-collect-garbage -d \
    && sudo rm /nix/var/nix/profiles/per-user/$NONEROOTUSER/profile/bin/nix-*

# COPY FOLLOWING TWO LINES:
RUN mkdir /etc/nix \ 
 && echo "substituters        = https://hydra.iohk.io https://iohk.cachix.org https://cache.nixos.org/" >> /etc/nix/nix.conf \
 && echo "trusted-public-keys = hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ= iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=" >> /etc/nix/nix.conf

# STEP TWO: INSTALL HASKELL
RUN sudo apt-get install haskell-platform \
  && sudo apt-get update --fix-missing \
  && cabal update

# STEP THREE: INSTALL PLUTUS

RUN git clone https://github.com/input-output-hk/plutus.git \
 && cd plutus/ \
 && nix build -f default.nix plutus.haskell.packages.plutus-core.components.library

# ADD SCRIPT
ADD addfile/banner.txt /home/$NONEROOTUSER/.scripts/
ADD addfile/downG.sh /home/$NONEROOTUSER/.scripts/
ADD addfile/entrypoint.sh /home/$NONEROOTUSER/

RUN sudo chown -R $NONEROOTUSER:$NONEROOTUSER $CNODE_HOME/* \
    && sudo chown -R $NONEROOTUSER:$NONEROOTUSER /home/$NONEROOTUSER/.* \
    && sudo chmod a+x /home/$NONEROOTUSER/.scripts/*.sh /home/$NONEROOTUSER/entrypoint.sh
    
ENTRYPOINT ["./entrypoint.sh"]
